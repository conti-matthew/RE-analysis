<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Calculator</title>
    <!-- Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for capturing a screenshot -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        canvas {
            width: 100% !important;
            height: 300px !important;
        }
        /* Modal styling for all pop-ups */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: #9ca3af;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: #1f2937;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #1f2937;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white shadow-xl rounded-2xl p-8 lg:p-12">
        <h1 class="text-4xl lg:text-5xl font-bold text-center mb-6 text-gray-800">Real Estate Investment Calculator</h1>
        <p class="text-center text-gray-600 mb-10">Compare up to four properties side-by-side to find the best deal.</p>

        <!-- Main content grid -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 lg:gap-12">

            <!-- Input and controls section -->
            <div>
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Property Details</h2>
                <div id="analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Initial Analysis 1 Section -->
                    <div id="analysis1" class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-blue-800 mb-4 flex justify-between items-center">
                            Analysis 1
                            <button class="close-analysis-btn text-gray-400 hover:text-red-500 transition-colors" data-index="1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </h3>
                        <div class="space-y-4">
                            <div class="flex flex-col">
                                <label for="address1" class="text-sm font-medium text-gray-700 mb-1">Property Address</label>
                                <input type="text" id="address1" placeholder="e.g., 123 Main St, Anytown" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                                <button id="mapBtn1" class="mt-2 bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors w-full">Map</button>
                            </div>
                            <div class="flex flex-col">
                                <label for="price1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Purchase Price ($)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Purchase Price">?</button>
                                </label>
                                <input type="number" id="price1" value="300000" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="downPayment1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Down Payment (%)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Down Payment">?</button>
                                </label>
                                <input type="number" id="downPayment1" value="20" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="rate1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Interest Rate (%)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Interest Rate">?</button>
                                </label>
                                <input type="number" id="rate1" value="6.5" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="term1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Loan Term (Years)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Loan Term">?</button>
                                </label>
                                <input type="number" id="term1" value="30" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="income1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Gross Rental Income ($/mo)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Gross Rental Income">?</button>
                                </label>
                                <input type="number" id="income1" value="2500" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="vacancy1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Vacancy Rate (%)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Vacancy Rate">?</button>
                                </label>
                                <input type="number" id="vacancy1" value="5" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="propertyManagement1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Property Management (%)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Property Management">?</button>
                                </label>
                                <input type="number" id="propertyManagement1" value="8" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="taxes1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Property Taxes ($/yr)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Property Taxes">?</button>
                                </label>
                                <input type="number" id="taxes1" value="3600" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="insurance1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Insurance ($/mo)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Insurance">?</button>
                                </label>
                                <input type="number" id="insurance1" value="150" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="repairs1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Repairs & Maintenance ($/mo)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Repairs & Maintenance">?</button>
                                </label>
                                <input type="number" id="repairs1" value="100" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                            <div class="flex flex-col">
                                <label for="capex1" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Capital Expenditures ($/mo)
                                    <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Capital Expenditures">?</button>
                                </label>
                                <input type="number" id="capex1" value="100" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results and Charts section -->
            <div class="relative">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Comparison Results</h2>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Initial Result 1 Section -->
                    <div id="result1" class="bg-gray-50 border border-gray-200 rounded-xl p-6 transition-all duration-300 ease-in-out">
                        <p class="text-xl font-bold mb-2 text-gray-800">Analysis 1</p>
                        <div id="recommendation1" class="hidden text-center font-bold text-sm mb-4 p-2 rounded-lg text-white"></div>
                        <p id="monthlyPayment1" class="text-gray-600">Mortgage: -</p>
                        <p class="text-lg font-bold mt-4 text-gray-800">Monthly Cash Flow</p>
                        <p id="cashFlow1" class="text-2xl font-bold text-gray-700"> - </p>
                        <p class="text-lg font-bold mt-4 text-gray-800">Cap Rate</p>
                        <p id="capRate1" class="text-2xl font-bold text-gray-700"> - </p>
                        <p class="text-lg font-bold mt-4 text-gray-800">Cash-on-Cash</p>
                        <p id="cashOnCash1" class="text-2xl font-bold text-gray-700"> - </p>
                        <button class="expense-breakdown-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full mt-4 hover:bg-gray-300 transition-colors" data-index="1">
                            Expense Breakdown
                        </button>
                    </div>
                </div>
                <div id="winner" class="mt-8 text-center text-2xl font-bold"></div>
                
                <!-- Graph section for comparison -->
                <div class="mt-12">
                    <h4 class="text-2xl font-semibold text-gray-700 mb-4">Comparison Chart</h4>
                    <div class="flex items-center space-x-4 mb-6">
                        <select id="chartType" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                        </select>
                        <select id="chartMetric" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="cashFlow">Monthly Cash Flow</option>
                            <option value="capRate">Cap Rate</option>
                            <option value="cashOnCash">Cash-on-Cash Return</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons at the bottom -->
        <div class="flex flex-wrap items-center justify-center mt-10 space-y-4 lg:space-y-0 lg:space-x-4">
            <button id="addAnalysisBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 w-full md:w-auto">
                Add Another Analysis
            </button>
            <button id="saveAnalysesBtn" class="bg-yellow-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-yellow-600 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 w-full md:w-auto">
                Save Analyses
            </button>
            <button id="loadAnalysesBtn" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 w-full md:w-auto">
                Load Analyses
            </button>
            <button id="printScreenBtn" class="bg-gray-200 text-gray-800 font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 w-full md:w-auto">
                Print Screen
            </button>
            <button id="shareBtn" class="bg-gray-200 text-gray-800 font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 w-full md:w-auto">
                Share Link
            </button>
        </div>
        <div id="copy-message" class="mt-4 text-center text-sm text-gray-500 hidden">Link copied to clipboard!</div>
        <div id="save-message" class="mt-4 text-center text-sm text-gray-500 hidden"></div>
    </div>

    <!-- Modal for the print screen image -->
    <div id="printScreenModal" class="modal">
        <div class="modal-content text-center">
            <span class="modal-close">&times;</span>
            <h3 class="text-2xl font-bold mb-4">Snapshot</h3>
            <img id="printScreenImage" class="w-full h-auto rounded-lg shadow-lg">
            <div class="mt-6">
                 <button id="downloadBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105 active:scale-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Download Image
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Expense Breakdown -->
    <div id="expenseBreakdownModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-expense-breakdown">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-center">Monthly Expense Breakdown</h3>
            <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                 <canvas id="expenseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal for Help/Tooltips -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-help">&times;</span>
            <h3 id="helpModalTitle" class="text-2xl font-bold mb-4 text-center">Help</h3>
            <p id="helpModalContent" class="text-gray-700"></p>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <p>Generating snapshot...</p>
    </div>

    <script>
        const analysisContainer = document.getElementById('analysis-container');
        const resultsGrid = document.getElementById('results-grid');
        const addAnalysisBtn = document.getElementById('addAnalysisBtn');
        const saveAnalysesBtn = document.getElementById('saveAnalysesBtn');
        const loadAnalysesBtn = document.getElementById('loadAnalysesBtn');
        const shareBtn = document.getElementById('shareBtn');
        const printScreenBtn = document.getElementById('printScreenBtn');
        const chartMetricSelector = document.getElementById('chartMetric');
        const chartTypeSelector = document.getElementById('chartType');
        const copyMessageEl = document.getElementById('copy-message');
        const saveMessageEl = document.getElementById('save-message');

        const printScreenModal = document.getElementById('printScreenModal');
        const modalCloseBtn = document.querySelector('.modal-close');
        const printScreenImage = document.getElementById('printScreenImage');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const expenseBreakdownModal = document.getElementById('expenseBreakdownModal');
        const expenseModalCloseBtn = document.querySelector('.modal-close-expense-breakdown');
        const expenseChartCtx = document.getElementById('expenseChart').getContext('2d');
        let expenseChartInstance = null;

        const helpModal = document.getElementById('helpModal');
        const helpModalTitle = document.getElementById('helpModalTitle');
        const helpModalContent = document.getElementById('helpModalContent');
        const helpModalCloseBtn = document.querySelector('.modal-close-help');

        let analysisCount = 1;
        const analysisColors = ['#3b82f6', '#22c55e', '#a855f7', '#eab308'];
        const analysisBgColors = ['bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50'];
        const analysisBorderColors = ['border-blue-200', 'border-green-200', 'border-purple-200', 'border-yellow-200'];
        const analysisTextColors = ['text-blue-800', 'text-green-800', 'text-purple-800', 'text-yellow-800'];
        const analysisPlaceholder = [
            'e.g., 123 Main St, Anytown',
            'e.g., 456 Elm St, Othertown',
            'e.g., 789 Oak Ave, Yourtown',
            'e.g., 101 Pine St, Mycity'
        ];
        const analysisRingColors = ['focus:ring-blue-500', 'focus:ring-green-500', 'focus:ring-purple-500', 'focus:ring-yellow-500'];
        const analysisMapBtnBg = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500'];
        const analysisMapBtnHoverBg = ['hover:bg-blue-600', 'hover:bg-green-600', 'hover:bg-purple-600', 'hover:bg-yellow-600'];

        let myChart = null; // Variable to hold the Chart.js instance

        const calculatedResults = {
            cashFlows: [],
            capRates: [],
            cashOnCash: [],
            labels: [],
            expenses: []
        };

        const helpTexts = {
            "Purchase Price": "The total price you pay to acquire the property.",
            "Down Payment": "The portion of the purchase price you pay upfront, expressed as a percentage. The remaining amount is typically financed with a loan.",
            "Interest Rate": "The cost of borrowing money for your mortgage, expressed as an annual percentage. This affects your monthly mortgage payment.",
            "Loan Term": "The length of time over which the loan will be repaid, usually 15 or 30 years.",
            "Gross Rental Income": "The total monthly rent collected from the property before any expenses are paid.",
            "Vacancy Rate": "The percentage of time the property is expected to be vacant. This is a crucial factor for estimating a realistic income.",
            "Property Management": "The fee paid to a professional property manager, typically a percentage of the gross rental income.",
            "Property Taxes": "Taxes paid to the local government, usually calculated on an annual basis.",
            "Insurance": "The cost of insuring the property against damage and other risks, typically paid monthly.",
            "Repairs & Maintenance": "A monthly budget for routine repairs and general upkeep of the property.",
            "Capital Expenditures": "A budget for major, non-recurring expenses like a new roof, HVAC system, or significant repairs. This is an important factor for long-term planning."
        };

        // Helper function to create an analysis section HTML string
        function createAnalysisSection(index, data = {}) {
            const defaults = [
                { price: 300000, downPayment: 20, rate: 6.5, term: 30, income: 2500, vacancy: 5, propertyManagement: 8, taxes: 3600, insurance: 150, repairs: 100, capex: 100, address: '' },
                { price: 400000, downPayment: 20, rate: 7.0, term: 30, income: 3000, vacancy: 5, propertyManagement: 8, taxes: 4800, insurance: 200, repairs: 100, capex: 100, address: '' },
                { price: 350000, downPayment: 20, rate: 6.8, term: 30, income: 2800, vacancy: 5, propertyManagement: 8, taxes: 4200, insurance: 175, repairs: 100, capex: 100, address: '' },
                { price: 250000, downPayment: 25, rate: 6.2, term: 30, income: 2100, vacancy: 5, propertyManagement: 8, taxes: 3000, insurance: 120, repairs: 100, capex: 100, address: '' }
            ];
            const d = data.price ? data : defaults[index - 1];

            return `
                <div id="analysis${index}" class="${analysisBgColors[index-1]} ${analysisBorderColors[index-1]} rounded-xl p-6">
                    <h3 class="text-2xl font-bold ${analysisTextColors[index-1]} mb-4 flex justify-between items-center">
                        Analysis ${index}
                        <button class="close-analysis-btn text-gray-400 hover:text-red-500 transition-colors" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </h3>
                    <div class="space-y-4">
                        <div class="flex flex-col">
                            <label for="address${index}" class="text-sm font-medium text-gray-700 mb-1">Property Address</label>
                            <input type="text" id="address${index}" placeholder="${analysisPlaceholder[index-1]}" value="${d.address}" class="deal-input p-3 border border-gray-300 rounded-lg ${analysisRingColors[index-1]} ${analysisBorderColors[index-1]} w-full">
                            <button id="mapBtn${index}" class="mt-2 ${analysisMapBtnBg[index-1]} text-white p-3 rounded-lg ${analysisMapBtnHoverBg[index-1]} transition-colors w-full">Map</button>
                        </div>
                        <div class="flex flex-col">
                            <label for="price${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Purchase Price ($)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Purchase Price">?</button>
                            </label>
                            <input type="number" id="price${index}" value="${d.price}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="downPayment${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Down Payment (%)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Down Payment">?</button>
                            </label>
                            <input type="number" id="downPayment${index}" value="${d.downPayment}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="rate${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Interest Rate (%)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Interest Rate">?</button>
                            </label>
                            <input type="number" id="rate${index}" value="${d.rate}" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="term${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Loan Term (Years)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Loan Term">?</button>
                            </label>
                            <input type="number" id="term${index}" value="${d.term}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="income${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Gross Rental Income ($/mo)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Gross Rental Income">?</button>
                            </label>
                            <input type="number" id="income${index}" value="${d.income}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="vacancy${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Vacancy Rate (%)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Vacancy Rate">?</button>
                            </label>
                            <input type="number" id="vacancy${index}" value="${d.vacancy}" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="propertyManagement${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Property Management (%)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Property Management">?</button>
                            </label>
                            <input type="number" id="propertyManagement${index}" value="${d.propertyManagement}" step="0.1" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="taxes${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Property Taxes ($/yr)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Property Taxes">?</button>
                            </label>
                            <input type="number" id="taxes${index}" value="${d.taxes}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="insurance${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Insurance ($/mo)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Insurance">?</button>
                            </label>
                            <input type="number" id="insurance${index}" value="${d.insurance}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="repairs${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Repairs & Maintenance ($/mo)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Repairs & Maintenance">?</button>
                            </label>
                            <input type="number" id="repairs${index}" value="${d.repairs}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                        <div class="flex flex-col">
                            <label for="capex${index}" class="text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Capital Expenditures ($/mo)
                                <button class="help-btn ml-2 text-gray-400 hover:text-blue-500 transition-colors" data-term="Capital Expenditures">?</button>
                            </label>
                            <input type="number" id="capex${index}" value="${d.capex}" class="deal-input p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to create a result section HTML string
        function createResultSection(index) {
            return `
                <div id="result${index}" class="bg-gray-50 border border-gray-200 rounded-xl p-6 transition-all duration-300 ease-in-out">
                    <p class="text-xl font-bold mb-2 text-gray-800">Analysis ${index}</p>
                    <div id="recommendation${index}" class="hidden text-center font-bold text-sm mb-4 p-2 rounded-lg text-white"></div>
                    <p id="monthlyPayment${index}" class="text-gray-600">Mortgage: -</p>
                    <p class="text-lg font-bold mt-4 text-gray-800">Monthly Cash Flow</p>
                    <p id="cashFlow${index}" class="text-2xl font-bold text-gray-700"> - </p>
                    <p class="text-lg font-bold mt-4 text-gray-800">Cap Rate</p>
                    <p id="capRate${index}" class="text-2xl font-bold text-gray-700"> - </p>
                    <p class="text-lg font-bold mt-4 text-gray-800">Cash-on-Cash</p>
                    <p id="cashOnCash${index}" class="text-2xl font-bold text-gray-700"> - </p>
                    <button class="expense-breakdown-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full mt-4 hover:bg-gray-300 transition-colors" data-index="${index}">
                        Expense Breakdown
                    </button>
                </div>
            `;
        }

        // Add a new analysis section
        function addAnalysis() {
            if (analysisCount >= analysisColors.length) {
                showMessageBox("You can only add up to 4 analyses for comparison.");
                return;
            }
            analysisCount++;
            const newAnalysisHtml = createAnalysisSection(analysisCount);
            const newResultHtml = createResultSection(analysisCount);
            analysisContainer.insertAdjacentHTML('beforeend', newAnalysisHtml);
            resultsGrid.insertAdjacentHTML('beforeend', newResultHtml);
            attachListeners();
            calculateMetrics(analysisCount);
            updateChart();
        }

        // Remove an analysis section
        function removeAnalysis(index) {
            const analysisToRemove = document.getElementById(`analysis${index}`);
            const resultToRemove = document.getElementById(`result${index}`);
            if (analysisToRemove) {
                analysisToRemove.remove();
            }
            if (resultToRemove) {
                resultToRemove.remove();
            }
            // Re-index remaining analyses
            reIndexAnalyses();
            updateChart();
        }

        // Re-index analyses after one is removed
        function reIndexAnalyses() {
            const analyses = analysisContainer.querySelectorAll('[id^="analysis"]');
            const results = resultsGrid.querySelectorAll('[id^="result"]');
            analysisCount = 0;
            for (let i = 0; i < analyses.length; i++) {
                analysisCount++;
                const newIndex = i + 1;
                const analysisEl = analyses[i];
                const resultEl = results[i];

                analysisEl.id = `analysis${newIndex}`;
                analysisEl.className = `${analysisBgColors[i]} ${analysisBorderColors[i]} rounded-xl p-6`;
                analysisEl.querySelector('h3').innerHTML = `Analysis ${newIndex} <button class="close-analysis-btn text-gray-400 hover:text-red-500 transition-colors" data-index="${newIndex}"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                analysisEl.querySelector('h3').className = `text-2xl font-bold ${analysisTextColors[i]} mb-4 flex justify-between items-center`;
                
                const inputs = analysisEl.querySelectorAll('input');
                inputs.forEach(input => {
                    const oldId = input.id;
                    const newId = oldId.replace(/\d+$/, newIndex);
                    input.id = newId;
                    input.placeholder = analysisPlaceholder[i];
                    input.className = `deal-input p-3 border border-gray-300 rounded-lg ${analysisRingColors[i]} ${analysisBorderColors[i]} w-full`;
                });
                
                const labels = analysisEl.querySelectorAll('label');
                labels.forEach(label => {
                    const oldFor = label.htmlFor;
                    const newFor = oldFor.replace(/\d+$/, newIndex);
                    label.htmlFor = newFor;
                });
                
                const mapBtn = analysisEl.querySelector('[id^="mapBtn"]');
                if (mapBtn) {
                     mapBtn.id = `mapBtn${newIndex}`;
                     mapBtn.className = `mt-2 ${analysisMapBtnBg[i]} text-white p-3 rounded-lg ${analysisMapBtnHoverBg[i]} transition-colors w-full`;
                }
                
                resultEl.id = `result${newIndex}`;
                resultEl.querySelector('p:first-child').textContent = `Analysis ${newIndex}`;
                resultEl.querySelector('.expense-breakdown-btn').dataset.index = newIndex;
            }
            attachListeners(); // Re-attach all listeners
        }

                        // Determine the winner
                const resultCard = document.getElementById(`result${i}`);
                const recommendation = document.getElementById(`recommendation${i}`);
                resultCard.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
                recommendation.classList.add('hidden');

                if (monthlyCashFlow > bestCashFlow) {
                    bestCashFlow = monthlyCashFlow;
                    cashFlowWinner = i;
                }
                if (capRate > bestCapRate) {
                    bestCapRate = capRate;
                    capRateWinner = i;
                }
                if (cashOnCash > bestCashOnCash) {
                    bestCashOnCash = cashOnCash;
                    cashOnCashWinner = i;
                }
            }
            
            // Highlight the winner based on the chosen metric
            updateWinnerDisplay(chartMetricSelector.value);

            // Update the chart
            updateChart();
        }
        
        function updateWinnerDisplay(metric) {
            let winner = null;
            let winningValue = -Infinity;
            let winnerMessage = "";

            // Reset all result cards
            for (let i = 1; i <= 4; i++) {
                const resultCard = document.getElementById(`result${i}`);
                if (resultCard) {
                    resultCard.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
                    const rec = document.getElementById(`recommendation${i}`);
                    if (rec) rec.classList.add('hidden');
                }
            }

            if (metric === 'cashFlow') {
                for (let i = 0; i < calculatedResults.cashFlows.length; i++) {
                    if (calculatedResults.cashFlows[i] > winningValue) {
                        winningValue = calculatedResults.cashFlows[i];
                        winner = i + 1;
                    }
                }
                if (winner) winnerMessage = `Analysis ${winner} wins with the highest Monthly Cash Flow!`;
            } else if (metric === 'capRate') {
                for (let i = 0; i < calculatedResults.capRates.length; i++) {
                    if (calculatedResults.capRates[i] > winningValue) {
                        winningValue = calculatedResults.capRates[i];
                        winner = i + 1;
                    }
                }
                if (winner) winnerMessage = `Analysis ${winner} wins with the highest Cap Rate!`;
            } else if (metric === 'cashOnCash') {
                for (let i = 0; i < calculatedResults.cashOnCash.length; i++) {
                    if (calculatedResults.cashOnCash[i] > winningValue) {
                        winningValue = calculatedResults.cashOnCash[i];
                        winner = i + 1;
                    }
                }
                if (winner) winnerMessage = `Analysis ${winner} wins with the highest Cash-on-Cash Return!`;
            }

            const winnerElement = document.getElementById('winner');
            winnerElement.textContent = winnerMessage;
            
            if (winner) {
                const winningCard = document.getElementById(`result${winner}`);
                winningCard.classList.add('bg-green-100', 'border-green-400');
                const winningRecommendation = document.getElementById(`recommendation${winner}`);
                winningRecommendation.textContent = "BEST OPTION";
                winningRecommendation.classList.remove('hidden');
                winningRecommendation.classList.add('bg-green-500');
            }
        }
        
        // Function to get a recommendation based on investment metrics
        function getRecommendation(monthlyCashFlow, capRate, cashOnCashReturn) {
            let recommendation = { text: '', style: '' };

            if (monthlyCashFlow > 200 && capRate > 0.07 && cashOnCashReturn > 0.12) {
                recommendation.text = 'Excellent Deal! Highly Recommended! ï¿½';
                recommendation.style = 'bg-green-600';
            } else if (monthlyCashFlow > 50 && capRate > 0.05 && cashOnCashReturn > 0.08) {
                recommendation.text = 'Good Potential. Worth Considering. ðŸ‘';
                recommendation.style = 'bg-yellow-600';
            } else if (monthlyCashFlow >= -100 && capRate > 0.02) {
                recommendation.text = 'Marginal Deal. Proceed with caution. ðŸ§';
                recommendation.style = 'bg-orange-600';
            } else {
                recommendation.text = 'Poor Investment. Not Recommended! ðŸ‘Ž';
                recommendation.style = 'bg-red-600';
            }
            return recommendation;
        }

        // Calculate investment metrics
        function calculateMetrics(index) {
            const price = parseFloat(document.getElementById(`price${index}`).value) || 0;
            const downPayment = parseFloat(document.getElementById(`downPayment${index}`).value) / 100 || 0;
            const rate = parseFloat(document.getElementById(`rate${index}`).value) / 100 / 12 || 0;
            const term = parseFloat(document.getElementById(`term${index}`).value) || 0;
            const income = parseFloat(document.getElementById(`income${index}`).value) || 0;
            const vacancy = parseFloat(document.getElementById(`vacancy${index}`).value) / 100 || 0;
            const propertyManagement = parseFloat(document.getElementById(`propertyManagement${index}`).value) / 100 || 0;
            const taxes = parseFloat(document.getElementById(`taxes${index}`).value) / 12 || 0;
            const insurance = parseFloat(document.getElementById(`insurance${index}`).value) || 0;
            const repairs = parseFloat(document.getElementById(`repairs${index}`).value) || 0;
            const capex = parseFloat(document.getElementById(`capex${index}`).value) || 0;

            if (price === 0) return;

            // Mortgage calculation
            const loanAmount = price * (1 - downPayment);
            const numPayments = term * 12;
            let monthlyPayment = 0;
            if (rate > 0) {
                monthlyPayment = loanAmount * (rate * Math.pow(1 + rate, numPayments)) / (Math.pow(1 + rate, numPayments) - 1);
            } else {
                monthlyPayment = loanAmount / numPayments;
            }

            // Expenses and income
            const grossOperatingIncome = income * (1 - vacancy);
            const operatingExpenses = (grossOperatingIncome * propertyManagement) + taxes + insurance + repairs + capex;
            const netOperatingIncome = grossOperatingIncome - operatingExpenses;

            // Metrics
            const cashFlow = netOperatingIncome - monthlyPayment;
            const capRate = (netOperatingIncome * 12) / price;
            const cashOnCash = cashFlow * 12 / (price * downPayment);
            const recommendation = getRecommendation(cashFlow, capRate, cashOnCash);

            const cashFlowEl = document.getElementById(`cashFlow${index}`);
            const recommendationEl = document.getElementById(`recommendation${index}`);
            
            document.getElementById(`monthlyPayment${index}`).textContent = `Mortgage: $${monthlyPayment.toFixed(2)}`;
            cashFlowEl.textContent = `$${cashFlow.toFixed(2)}`;
            document.getElementById(`capRate${index}`).textContent = `${(capRate * 100).toFixed(2)}%`;
            document.getElementById(`cashOnCash${index}`).textContent = `${(cashOnCash * 100).toFixed(2)}%`;

            // Display and style the recommendation
            if (recommendation.text) {
                recommendationEl.textContent = recommendation.text;
                recommendationEl.className = `${recommendation.style} text-white text-center font-bold text-sm mb-4 p-2 rounded-lg`;
                recommendationEl.classList.remove('hidden');
            } else {
                recommendationEl.classList.add('hidden');
            }

            // Highlight cash flow based on value
            if (cashFlow > 0) {
                cashFlowEl.classList.remove('text-red-600');
                cashFlowEl.classList.add('text-green-600');
            } else {
                cashFlowEl.classList.remove('text-green-600');
                cashFlowEl.classList.add('text-red-600');
            }

            // Store results
            calculatedResults.cashFlows[index - 1] = cashFlow;
            calculatedResults.capRates[index - 1] = capRate * 100;
            calculatedResults.cashOnCash[index - 1] = cashOnCash * 100;
            calculatedResults.labels[index - 1] = `Analysis ${index}`;
            calculatedResults.expenses[index - 1] = {
                mortgage: monthlyPayment,
                vacancy: income * vacancy,
                propertyManagement: grossOperatingIncome * propertyManagement,
                taxes: taxes,
                insurance: insurance,
                repairs: repairs,
                capex: capex
            };
        }

        // Update the chart with the latest data
        function updateChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const chartType = chartTypeSelector.value;
            const chartMetric = chartMetricSelector.value;
            const labels = calculatedResults.labels.slice(0, analysisCount);
            let data = [];
            let winnerIndex = -1;
            let winnerValue = -Infinity;
            const winnerTextEl = document.getElementById('winner');

            if (chartMetric === 'cashFlow') {
                data = calculatedResults.cashFlows.slice(0, analysisCount);
            } else if (chartMetric === 'capRate') {
                data = calculatedResults.capRates.slice(0, analysisCount);
            } else {
                data = calculatedResults.cashOnCash.slice(0, analysisCount);
            }

            // Determine the winner
            data.forEach((value, index) => {
                if (value > winnerValue) {
                    winnerValue = value;
                    winnerIndex = index + 1;
                }
            });
            winnerTextEl.textContent = winnerIndex > 0 ? `Winner: Analysis ${winnerIndex}` : '';

            const datasets = [{
                label: chartMetric === 'cashFlow' ? 'Monthly Cash Flow' :
                       chartMetric === 'capRate' ? 'Cap Rate (%)' :
                       'Cash-on-Cash Return (%)',
                data: data,
                backgroundColor: analysisColors.slice(0, analysisCount).map(color => `${color}80`), // Add transparency
                borderColor: analysisColors.slice(0, analysisCount),
                borderWidth: 2, // Thicker border for better visibility
            }];

            if (myChart) {
                myChart.destroy();
            }

            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Investment Comparison',
                        font: { size: 18, weight: 'bold', family: 'Inter, sans-serif' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: { family: 'Inter, sans-serif' }
                        }
                    },
                    x: {
                        ticks: {
                            font: { family: 'Inter, sans-serif' }
                        }
                    }
                }
            };
            
            if (chartType === 'pie') {
                myChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets,
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: {
                                display: true,
                                text: 'Investment Comparison',
                                font: { size: 18, weight: 'bold', family: 'Inter, sans-serif' }
                            }
                        },
                        layout: {
                            padding: 20
                        }
                    }
                });
            } else {
                myChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets,
                    },
                    options: chartOptions,
                });
            }
        }

        // Attach event listeners to all analysis sections and buttons
        function attachListeners() {
            const dealInputs = document.querySelectorAll('.deal-input');
            dealInputs.forEach(input => {
                input.removeEventListener('input', handleInput);
                input.addEventListener('input', handleInput);
            });
            
            const closeButtons = document.querySelectorAll('.close-analysis-btn');
            closeButtons.forEach(btn => {
                btn.removeEventListener('click', handleCloseButtonClick);
                btn.addEventListener('click', handleCloseButtonClick);
            });

            const expenseButtons = document.querySelectorAll('.expense-breakdown-btn');
            expenseButtons.forEach(btn => {
                btn.removeEventListener('click', handleExpenseBreakdownClick);
                btn.addEventListener('click', handleExpenseBreakdownClick);
            });

            const mapButtons = document.querySelectorAll('[id^="mapBtn"]');
            mapButtons.forEach(btn => {
                btn.removeEventListener('click', handleMapButtonClick);
                btn.addEventListener('click', handleMapButtonClick);
            });

            const helpButtons = document.querySelectorAll('.help-btn');
            helpButtons.forEach(btn => {
                btn.removeEventListener('click', handleHelpButtonClick);
                btn.addEventListener('click', handleHelpButtonClick);
            });
        }

        function handleInput(event) {
            const index = event.target.id.match(/\d+/)[0];
            calculateMetrics(index);
            updateChart();
        }

        function handleCloseButtonClick(event) {
            const index = event.currentTarget.dataset.index;
            if (analysisCount > 1) {
                removeAnalysis(index);
            } else {
                showMessageBox("You must have at least one analysis.");
            }
        }

        function handleMapButtonClick(event) {
            const index = event.target.id.match(/\d+/)[0];
            const address = document.getElementById(`address${index}`).value;
            if (address) {
                window.open(`https://www.google.com/maps/place/${encodeURIComponent(address)}`, '_blank');
            } else {
                showMessageBox("Please enter a property address first.");
            }
        }

        function handleExpenseBreakdownClick(event) {
            const index = parseInt(event.currentTarget.dataset.index);
            const expenses = calculatedResults.expenses[index - 1];
            if (expenses) {
                showExpenseBreakdown(expenses, index);
            } else {
                showMessageBox("Please calculate the metrics for this analysis first.");
            }
        }

        function handleHelpButtonClick(event) {
            const term = event.target.dataset.term;
            const content = helpTexts[term] || "No description available.";
            showHelpModal(term, content);
        }

        // Show a message box
        function showMessageBox(message) {
            const existingModal = document.getElementById('messageBoxModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHtml = `
                <div id="messageBoxModal" class="modal" style="display: flex;">
                    <div class="modal-content text-center">
                        <span class="modal-close" onclick="document.getElementById('messageBoxModal').remove()">&times;</span>
                        <p class="text-xl font-semibold text-gray-800">${message}</p>
                        <button class="mt-4 bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition-colors" onclick="document.getElementById('messageBoxModal').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Display the expense breakdown modal
        function showExpenseBreakdown(expenses, index) {
            const expenseLabels = ['Mortgage', 'Vacancy', 'Property Management', 'Taxes', 'Insurance', 'Repairs', 'Capex'];
            const expenseValues = [
                expenses.mortgage,
                expenses.vacancy,
                expenses.propertyManagement,
                expenses.taxes,
                expenses.insurance,
                expenses.repairs,
                expenses.capex
            ].map(value => parseFloat(value).toFixed(2));
            
            const expenseBreakdownModal = document.getElementById('expenseBreakdownModal');
            const expenseChartCtx = document.getElementById('expenseChart').getContext('2d');
            const modalTitle = expenseBreakdownModal.querySelector('h3');
            modalTitle.textContent = `Monthly Expense Breakdown for Analysis ${index}`;

            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }

            expenseChartInstance = new Chart(expenseChartCtx, {
                type: 'pie',
                data: {
                    labels: expenseLabels,
                    datasets: [{
                        data: expenseValues,
                        backgroundColor: [
                            '#eab308', // yellow
                            '#3b82f6', // blue
                            '#a855f7', // purple
                            '#22c55e', // green
                            '#f97316', // orange
                            '#ef4444', // red
                            '#6b7280' // gray
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { 
                            display: true, 
                            text: `Analysis ${index} Monthly Expenses`,
                            font: { size: 18, weight: 'bold', family: 'Inter, sans-serif' }
                        }
                    }
                }
            });
            expenseBreakdownModal.style.display = 'flex';
        }

        // Display the help modal
        function showHelpModal(title, content) {
            helpModalTitle.textContent = title;
            helpModalContent.textContent = content;
            helpModal.style.display = 'flex';
        }

        // Event listener for the "Add Analysis" button
        addAnalysisBtn.addEventListener('click', addAnalysis);

        // Event listeners for chart controls
        chartMetricSelector.addEventListener('change', updateChart);
        chartTypeSelector.addEventListener('change', updateChart);
        
        // Event listener for the print screen button
        printScreenBtn.addEventListener('click', () => {
            loadingOverlay.style.display = 'flex';
            const container = document.querySelector('.container');
            html2canvas(container).then(canvas => {
                const imageDataUrl = canvas.toDataURL('image/png');
                printScreenImage.src = imageDataUrl;
                printScreenModal.style.display = 'flex';
                loadingOverlay.style.display = 'none';
            });
        });

        // Event listener for the download button inside the print screen modal
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'real_estate_analysis.png';
            link.href = printScreenImage.src;
            link.click();
        });

        // Event listeners for closing modals
        modalCloseBtn.addEventListener('click', () => {
            printScreenModal.style.display = 'none';
        });
        expenseModalCloseBtn.addEventListener('click', () => {
            expenseBreakdownModal.style.display = 'none';
        });
        helpModalCloseBtn.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target == printScreenModal) {
                printScreenModal.style.display = 'none';
            }
            if (event.target == expenseBreakdownModal) {
                expenseBreakdownModal.style.display = 'none';
            }
            if (event.target == helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // Event listener for the "Share" button
        shareBtn.addEventListener('click', () => {
            const data = [];
            for (let i = 1; i <= analysisCount; i++) {
                data.push({
                    address: document.getElementById(`address${i}`).value,
                    price: parseFloat(document.getElementById(`price${i}`).value) || 0,
                    downPayment: parseFloat(document.getElementById(`downPayment${i}`).value) || 0,
                    rate: parseFloat(document.getElementById(`rate${i}`).value) || 0,
                    term: parseFloat(document.getElementById(`term${i}`).value) || 0,
                    income: parseFloat(document.getElementById(`income${i}`).value) || 0,
                    vacancy: parseFloat(document.getElementById(`vacancy${i}`).value) || 0,
                    propertyManagement: parseFloat(document.getElementById(`propertyManagement${i}`).value) || 0,
                    taxes: parseFloat(document.getElementById(`taxes${i}`).value) || 0,
                    insurance: parseFloat(document.getElementById(`insurance${i}`).value) || 0,
                    repairs: parseFloat(document.getElementById(`repairs${i}`).value) || 0,
                    capex: parseFloat(document.getElementById(`capex${i}`).value) || 0,
                });
            }
            const encodedData = btoa(JSON.stringify(data));
            const shareUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?data=${encodedData}`;
            
            // Use a custom function to copy to clipboard due to iframe constraints
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyMessageEl.textContent = 'Link copied to clipboard!';
                    copyMessageEl.classList.remove('hidden');
                    setTimeout(() => copyMessageEl.classList.add('hidden'), 3000);
                } catch (err) {
                    copyMessageEl.textContent = 'Failed to copy link. Please copy it manually: ' + text;
                    copyMessageEl.classList.remove('hidden');
                }
                document.body.removeChild(textarea);
            }
            copyToClipboard(shareUrl);
        });

        // Event listener for the "Save" button
        saveAnalysesBtn.addEventListener('click', () => {
            const data = [];
            for (let i = 1; i <= analysisCount; i++) {
                data.push({
                    address: document.getElementById(`address${i}`).value,
                    price: parseFloat(document.getElementById(`price${i}`).value) || 0,
                    downPayment: parseFloat(document.getElementById(`downPayment${i}`).value) || 0,
                    rate: parseFloat(document.getElementById(`rate${i}`).value) || 0,
                    term: parseFloat(document.getElementById(`term${i}`).value) || 0,
                    income: parseFloat(document.getElementById(`income${i}`).value) || 0,
                    vacancy: parseFloat(document.getElementById(`vacancy${i}`).value) || 0,
                    propertyManagement: parseFloat(document.getElementById(`propertyManagement${i}`).value) || 0,
                    taxes: parseFloat(document.getElementById(`taxes${i}`).value) || 0,
                    insurance: parseFloat(document.getElementById(`insurance${i}`).value) || 0,
                    repairs: parseFloat(document.getElementById(`repairs${i}`).value) || 0,
                    capex: parseFloat(document.getElementById(`capex${i}`).value) || 0,
                });
            }
            localStorage.setItem('realEstateAnalyses', JSON.stringify(data));
            saveMessageEl.textContent = 'Analyses saved to local storage!';
            saveMessageEl.classList.remove('hidden');
            setTimeout(() => saveMessageEl.classList.add('hidden'), 3000);
        });

        // Event listener for the "Load" button
        loadAnalysesBtn.addEventListener('click', () => {
            const savedData = localStorage.getItem('realEstateAnalyses');
            if (savedData) {
                const data = JSON.parse(savedData);
                // Clear existing analyses
                while (analysisContainer.firstChild) {
                    analysisContainer.removeChild(analysisContainer.firstChild);
                }
                while (resultsGrid.firstChild) {
                    resultsGrid.removeChild(resultsGrid.firstChild);
                }
                analysisCount = 0;
                
                // Load saved data
                data.forEach(item => {
                    analysisCount++;
                    analysisContainer.insertAdjacentHTML('beforeend', createAnalysisSection(analysisCount, item));
                    resultsGrid.insertAdjacentHTML('beforeend', createResultSection(analysisCount));
                    calculateMetrics(analysisCount);
                });
                attachListeners();
                updateChart();
                saveMessageEl.textContent = 'Analyses loaded from local storage!';
                saveMessageEl.classList.remove('hidden');
                setTimeout(() => saveMessageEl.classList.add('hidden'), 3000);
            } else {
                saveMessageEl.textContent = 'No saved analyses found!';
                saveMessageEl.classList.remove('hidden');
                setTimeout(() => saveMessageEl.classList.add('hidden'), 3000);
            }
        });
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Check for shared data in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            if (sharedData) {
                try {
                    const data = JSON.parse(atob(sharedData));
                    // Clear initial analysis
                    document.getElementById('analysis1').remove();
                    document.getElementById('result1').remove();
                    analysisCount = 0;
                    // Load shared data
                    data.forEach(item => {
                        analysisCount++;
                        analysisContainer.insertAdjacentHTML('beforeend', createAnalysisSection(analysisCount, item));
                        resultsGrid.insertAdjacentHTML('beforeend', createResultSection(analysisCount));
                        calculateMetrics(analysisCount);
                    });
                } catch (e) {
                    console.error("Failed to parse shared data:", e);
                }
            } else {
                // If no shared data, calculate for the default first analysis
                calculateMetrics(1);
            }
            attachListeners();
            updateChart();
        });

    </script>
</body>
</html>
ï¿½
